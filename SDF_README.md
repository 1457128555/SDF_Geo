# SDF (Signed Distance Field) æ¨¡å—è¯´æ˜

## ğŸ“š æ¨¡å—æ¦‚è¿°

æœ¬æ¨¡å—æä¾›äº†2Då¤šè¾¹å½¢çš„æœ‰å‘è·ç¦»åœºï¼ˆSigned Distance Field, SDFï¼‰è®¡ç®—åŠŸèƒ½ã€‚SDFæ˜¯ä¸€ç§å¼ºå¤§çš„å‡ ä½•è¡¨ç¤ºæ–¹æ³•ï¼Œå¯ä»¥é«˜æ•ˆåœ°è¿›è¡Œç¢°æ’æ£€æµ‹ã€å½¢çŠ¶æ··åˆã€è½®å»“æå–ç­‰æ“ä½œã€‚

## ğŸ“ æ–‡ä»¶ç»“æ„

```
SDF_2D/
â”œâ”€â”€ sdf.h           # SDFæ¨¡å—å¤´æ–‡ä»¶ï¼ˆå‡½æ•°å£°æ˜ï¼‰
â”œâ”€â”€ sdf.cpp         # SDFæ¨¡å—å®ç°æ–‡ä»¶
â”œâ”€â”€ main.cpp        # ä¸»ç¨‹åºï¼ˆä½¿ç”¨SDFæ¨¡å—ï¼‰
â””â”€â”€ SDF_README.md   # æœ¬è¯´æ˜æ–‡æ¡£
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. SDFå€¼è®¡ç®—

```cpp
float calculatePolygonSDF(const Point2D& p, const std::vector<Point2D>& polygon);
```

**åŠŸèƒ½**ï¼šè®¡ç®—ç‚¹ç›¸å¯¹äºå¤šè¾¹å½¢çš„æœ‰å‘è·ç¦»
- **æ­£å€¼**ï¼šç‚¹åœ¨å¤šè¾¹å½¢å¤–éƒ¨ï¼ˆå€¼ä¸ºåˆ°æœ€è¿‘è¾¹ç•Œçš„è·ç¦»ï¼‰
- **è´Ÿå€¼**ï¼šç‚¹åœ¨å¤šè¾¹å½¢å†…éƒ¨ï¼ˆå€¼ä¸ºåˆ°æœ€è¿‘è¾¹ç•Œçš„è·ç¦»ï¼‰
- **é›¶å€¼**ï¼šç‚¹åœ¨å¤šè¾¹å½¢è¾¹ç•Œä¸Š

**å‚æ•°**ï¼š
- `p`: æŸ¥è¯¢ç‚¹çš„åæ ‡
- `polygon`: å¤šè¾¹å½¢é¡¶ç‚¹æ•°ç»„ï¼ˆæŒ‰é¡ºåºè¿æ¥æˆé—­åˆå¤šè¾¹å½¢ï¼‰

**è¿”å›å€¼**ï¼šæœ‰å‘è·ç¦»å€¼

### 2. ç‚¹åˆ°çº¿æ®µè·ç¦»

```cpp
float pointToSegmentDistance(const Point2D& p, const Point2D& a, const Point2D& b);
```

**åŠŸèƒ½**ï¼šè®¡ç®—ç‚¹åˆ°çº¿æ®µçš„æœ€çŸ­è·ç¦»

**ç®—æ³•**ï¼š
1. å°†ç‚¹æŠ•å½±åˆ°çº¿æ®µä¸Š
2. å¦‚æœæŠ•å½±ç‚¹åœ¨çº¿æ®µå†…ï¼Œè¿”å›æŠ•å½±è·ç¦»
3. å¦‚æœæŠ•å½±ç‚¹åœ¨çº¿æ®µå¤–ï¼Œè¿”å›åˆ°æœ€è¿‘ç«¯ç‚¹çš„è·ç¦»

### 3. å†…å¤–åˆ¤å®š

```cpp
bool isPointInPolygon(const Point2D& p, const std::vector<Point2D>& polygon);
```

**åŠŸèƒ½**ï¼šåˆ¤æ–­ç‚¹æ˜¯å¦åœ¨å¤šè¾¹å½¢å†…éƒ¨

**ç®—æ³•**ï¼šç¼ ç»•æ•°ç®—æ³•ï¼ˆWinding Numberï¼‰
- å¯¹å‡¹å¤šè¾¹å½¢å’Œå‡¸å¤šè¾¹å½¢éƒ½æœ‰æ•ˆ
- æ¯”å°„çº¿æŠ•å°„æ³•æ›´å¯é 

### 4. SDFç½‘æ ¼ç”Ÿæˆ

```cpp
void generateSDFGrid(int width, int height,
                     float worldMinX, float worldMaxX,
                     float worldMinY, float worldMaxY,
                     const std::vector<Point2D>& polygon,
                     float* sdfData);
```

**åŠŸèƒ½**ï¼šåœ¨æŒ‡å®šåŒºåŸŸå†…é‡‡æ ·SDFå€¼ï¼Œç”Ÿæˆ2Dç½‘æ ¼

**ç”¨é€”**ï¼š
- å¯è§†åŒ–è·ç¦»åœº
- é¢„è®¡ç®—SDFçº¹ç†ç”¨äºGPUæ¸²æŸ“
- è¿›è¡ŒåŸºäºè·ç¦»åœºçš„æ“ä½œ

### 5. åŒ…å›´ç›’è®¡ç®—

```cpp
void calculatePolygonBounds(const std::vector<Point2D>& polygon,
                            float& outMinX, float& outMaxX,
                            float& outMinY, float& outMaxY);
```

**åŠŸèƒ½**ï¼šè®¡ç®—å¤šè¾¹å½¢çš„è½´å¯¹é½åŒ…å›´ç›’ï¼ˆAABBï¼‰

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ç”¨æ³•

```cpp
#include "sdf.h"
#include <vector>

int main()
{
    // å®šä¹‰ä¸€ä¸ªä¸‰è§’å½¢
    std::vector<Point2D> triangle = {
        {0.0f, 0.5f},   // é¡¶éƒ¨
        {-0.5f, -0.5f}, // å·¦ä¸‹
        {0.5f, -0.5f}   // å³ä¸‹
    };
    
    // æµ‹è¯•ç‚¹
    Point2D testPoint = {0.0f, 0.0f};
    
    // è®¡ç®—SDFå€¼
    float sdf = calculatePolygonSDF(testPoint, triangle);
    
    if (sdf < 0)
        std::cout << "ç‚¹åœ¨ä¸‰è§’å½¢å†…éƒ¨ï¼Œè·ç¦»è¾¹ç•Œ: " << -sdf << std::endl;
    else if (sdf > 0)
        std::cout << "ç‚¹åœ¨ä¸‰è§’å½¢å¤–éƒ¨ï¼Œè·ç¦»è¾¹ç•Œ: " << sdf << std::endl;
    else
        std::cout << "ç‚¹åœ¨ä¸‰è§’å½¢è¾¹ç•Œä¸Š" << std::endl;
    
    return 0;
}
```

### ç¢°æ’æ£€æµ‹

```cpp
// æ£€æŸ¥ä¸¤ä¸ªå¤šè¾¹å½¢æ˜¯å¦ç›¸äº¤
bool checkCollision(const std::vector<Point2D>& poly1,
                   const std::vector<Point2D>& poly2)
{
    // æ£€æŸ¥poly2çš„æ‰€æœ‰é¡¶ç‚¹æ˜¯å¦åœ¨poly1å†…éƒ¨
    for (const auto& point : poly2)
    {
        float sdf = calculatePolygonSDF(point, poly1);
        if (sdf <= 0)
            return true;  // æœ‰é¡¶ç‚¹åœ¨å†…éƒ¨ï¼Œå‘ç”Ÿç¢°æ’
    }
    
    // åå‘æ£€æŸ¥
    for (const auto& point : poly1)
    {
        float sdf = calculatePolygonSDF(point, poly2);
        if (sdf <= 0)
            return true;
    }
    
    return false;
}
```

### SDFåœºå¯è§†åŒ–

```cpp
// ç”ŸæˆSDFçº¹ç†ç”¨äºå¯è§†åŒ–
void visualizeSDFField(const std::vector<Point2D>& polygon)
{
    const int width = 256;
    const int height = 256;
    float* sdfData = new float[width * height];
    
    // ç”ŸæˆSDFç½‘æ ¼
    generateSDFGrid(width, height, -1.0f, 1.0f, -1.0f, 1.0f,
                   polygon, sdfData);
    
    // å°†SDFå€¼è½¬æ¢ä¸ºé¢œè‰²
    for (int i = 0; i < width * height; i++)
    {
        float sdf = sdfData[i];
        
        // ä½¿ç”¨é¢œè‰²ç¼–ç è·ç¦»
        if (sdf < 0)
        {
            // å†…éƒ¨ï¼šè“è‰²æ¸å˜
            float intensity = std::min(1.0f, -sdf);
            // è®¾ç½®åƒç´ é¢œè‰²ä¸º (0, 0, intensity)
        }
        else
        {
            // å¤–éƒ¨ï¼šçº¢è‰²æ¸å˜
            float intensity = std::min(1.0f, sdf);
            // è®¾ç½®åƒç´ é¢œè‰²ä¸º (intensity, 0, 0)
        }
    }
    
    delete[] sdfData;
}
```

## ğŸ¯ å®é™…åº”ç”¨

### åœ¨SDF_Geoé¡¹ç›®ä¸­çš„ä½¿ç”¨

1. **æ·»åŠ å¤šè¾¹å½¢**ï¼š
   - ç‚¹å‡»"æ·»åŠ ç‚¹"æŒ‰é’®
   - åœ¨çª—å£ä¸­ç‚¹å‡»è‡³å°‘3ä¸ªç‚¹å½¢æˆå¤šè¾¹å½¢

2. **æŸ¥çœ‹SDFä¿¡æ¯**ï¼š
   - UIä¼šæ˜¾ç¤º"SDF åŠŸèƒ½"éƒ¨åˆ†
   - å‹¾é€‰"æ˜¾ç¤ºSDFå¯è§†åŒ–"
   - è°ƒæ•´æµ‹è¯•ç‚¹ä½ç½®æŸ¥çœ‹SDFå€¼

3. **æµ‹è¯•ç‚¹åŠŸèƒ½**ï¼š
   - æ»‘åŠ¨"æµ‹è¯•ç‚¹ X/Y"æ»‘å—ç§»åŠ¨æµ‹è¯•ç‚¹
   - å®æ—¶æ˜¾ç¤ºè¯¥ç‚¹çš„SDFå€¼
   - é¢œè‰²æŒ‡ç¤ºï¼šè“è‰²=å†…éƒ¨ï¼Œæ©™è‰²=å¤–éƒ¨ï¼Œé»„è‰²=è¾¹ç•Œ

4. **å¤šè¾¹å½¢ä¿¡æ¯**ï¼š
   - æ˜¾ç¤ºå¤šè¾¹å½¢çš„åŒ…å›´ç›’èŒƒå›´
   - ç”¨äºäº†è§£å¤šè¾¹å½¢çš„ç©ºé—´åˆ†å¸ƒ

## ğŸ“Š ç®—æ³•å¤æ‚åº¦

- **SDFè®¡ç®—**: O(n)ï¼Œnä¸ºå¤šè¾¹å½¢è¾¹æ•°
- **å†…å¤–åˆ¤å®š**: O(n)
- **ç‚¹åˆ°çº¿æ®µè·ç¦»**: O(1)
- **ç½‘æ ¼ç”Ÿæˆ**: O(w Ã— h Ã— n)ï¼Œwå’Œhä¸ºç½‘æ ¼å®½é«˜

## ğŸ”¬ ç®—æ³•åŸç†

### ç¼ ç»•æ•°ç®—æ³•ï¼ˆWinding Numberï¼‰

è®¡ç®—ä»ç‚¹å‘å‡ºçš„å°„çº¿ç©¿è¿‡å¤šè¾¹å½¢è¾¹ç•Œçš„æ¬¡æ•°ï¼š
- å‘ä¸Šç©¿è¿‡ï¼šç¼ ç»•æ•°+1
- å‘ä¸‹ç©¿è¿‡ï¼šç¼ ç»•æ•°-1
- æœ€ç»ˆç¼ ç»•æ•°â‰ 0ï¼šç‚¹åœ¨å†…éƒ¨
- æœ€ç»ˆç¼ ç»•æ•°=0ï¼šç‚¹åœ¨å¤–éƒ¨

### ç‚¹åˆ°çº¿æ®µæŠ•å½±

ä½¿ç”¨å‘é‡æŠ•å½±å…¬å¼ï¼š
```
t = dot(pa, ba) / dot(ba, ba)
t_clamped = clamp(t, 0, 1)
closest_point = a + ba * t_clamped
distance = |p - closest_point|
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç©ºé—´åˆ’åˆ†**ï¼šå¯¹äºå¤æ‚å¤šè¾¹å½¢ï¼Œä½¿ç”¨BVHæˆ–ç©ºé—´å“ˆå¸ŒåŠ é€Ÿ
2. **å¹¶è¡Œè®¡ç®—**ï¼šSDFç½‘æ ¼ç”Ÿæˆå¯ä»¥å¹¶è¡ŒåŒ–
3. **é¢„è®¡ç®—**ï¼šå¯¹äºé™æ€å¤šè¾¹å½¢ï¼Œå¯ä»¥é¢„è®¡ç®—SDFçº¹ç†
4. **æ—©æœŸé€€å‡º**ï¼šåœ¨ç¢°æ’æ£€æµ‹ä¸­ä½¿ç”¨åŒ…å›´ç›’å¿«é€Ÿå‰”é™¤

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å¤šè¾¹å½¢è¦æ±‚**ï¼š
   - è‡³å°‘3ä¸ªé¡¶ç‚¹
   - é¡¶ç‚¹æŒ‰é¡ºåºè¿æ¥
   - å¯ä»¥æ˜¯å‡¹å¤šè¾¹å½¢æˆ–å‡¸å¤šè¾¹å½¢

2. **åæ ‡ç³»ç»Ÿ**ï¼š
   - ä½¿ç”¨å³æ‰‹åæ ‡ç³»
   - Yè½´å‘ä¸Šä¸ºæ­£
   - è·ç¦»å•ä½ä¸è¾“å…¥åæ ‡ä¸€è‡´

3. **æ•°å€¼ç²¾åº¦**ï¼š
   - ä½¿ç”¨floatç±»å‹
   - å¯¹äºæå°çš„å¤šè¾¹å½¢å¯èƒ½æœ‰ç²¾åº¦é—®é¢˜
   - å»ºè®®ä¿æŒåæ ‡åœ¨åˆç†èŒƒå›´å†…

## ğŸ”— æ‰©å±•é˜…è¯»

- [Signed Distance Functions - iquilezles](https://iquilezles.org/articles/distfunctions2d/)
- [Point in Polygon Test - Winding Number](https://en.wikipedia.org/wiki/Point_in_polygon)
- [Distance to Line Segment](https://mathworld.wolfram.com/Point-LineDistance2-Dimensional.html)

## ğŸ“„ è®¸å¯

æœ¬æ¨¡å—ä»£ç å¯è‡ªç”±ä½¿ç”¨å’Œä¿®æ”¹ï¼Œç”¨äºå­¦ä¹ å’Œé¡¹ç›®å¼€å‘ã€‚
